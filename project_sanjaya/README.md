# Project Sanjaya v2.1

Project Sanjaya is a privacy-first family safety system with a modular architecture that includes a FastAPI backend, Streamlit dashboards for the child, parent, and admin, and a robust set of features for real-time location tracking.

## Features

-   **Multiple Dashboards**: Separate Streamlit interfaces for child, parent, and admin users.
-   **Tracking Modes**: Supports college tracking and trip tracking (flight, train, road).
-   **Geofencing**: Allows users to define custom geofences with place names.
-   **Offline Caching**: The client can cache location data locally when offline and sync with the server upon reconnection.
-   **Unique Tracking Links**: Uses a unique, session-based tracking link generated by ngrok.
-   **Smart API Usage**: The AviationStack integration is designed to stay within the free tier limits (≤100 requests/month).

## Getting Started

### 1. Prerequisites

-   Python 3.10+
-   An ngrok account and authtoken
-   An AviationStack API key

### 2. Setup

**a. Clone the repository:**

```bash
git clone <repository_url>
cd project_sanjaya
```

**b. Create and configure the `.env` file:**

Create a `.env` file in the `project_sanjaya` directory and add the following, replacing the placeholder values with your actual secrets:

```
# A long, random string used for general cryptographic purposes.
SECRET_KEY='your_super_secret_key_here'

# The secret key for signing JWT tokens.
JWT_SECRET='your_jwt_secret_here'

# Your AviationStack API key.
AVIATIONSTACK_KEY='your_aviationstack_api_key_here'

# Your ngrok authtoken.
NGROK_AUTHTOKEN='your_ngrok_authtoken_here'
```

**c. Install the dependencies:**

```bash
pip install -r requirements.txt
```

### 3. Running the Application

The application consists of three main components that need to be run in separate terminals:

**a. Start the backend server:**

```bash
uvicorn project_sanjaya.backend.app:app --reload
```

The server will be running at `http://127.0.0.1:8000`.

**b. Start the ngrok tunnel:**

```bash
python project_sanjaya/scripts/ngrok_helper.py
```

This will expose your local server to the internet and print the public URL.

**c. Run the Streamlit dashboards:**

-   **Child Dashboard:**
    ```bash
    streamlit run project_sanjaya/dashboard/child_app.py
    ```

-   **Parent Dashboard:**
    ```bash
    streamlit run project_sanjaya/dashboard/parent_app.py
    ```

-   **Admin Dashboard:**
    ```bash
    streamlit run project_sanjaya/dashboard/admin_app.py
    ```

## Acceptance Tests

The following tests can be performed manually to verify the core functionality of the application:

-   **[✅] Child Account and Geofence:**
    1.  Create a child account using the child dashboard.
    2.  Define a "Home" and "College" geofence using the interactive map.
    3.  Start "College Tracking" and manually post a coordinate within the "Home" radius to the `/update_location` endpoint.
    4.  Verify that the parent dashboard shows the "Inside Home" label.

-   **[✅] Flight Trip and API Usage:**
    1.  Start a new trip with the "Flight" mode and a valid flight number.
    2.  Verify that the server returns a `session_hash`.
    3.  Check the `project_sanjaya/logs/api_usage.json` file to confirm that the AviationStack API call counter has been incremented.

-   **[✅] Parent Live Map:**
    1.  Log in to the parent dashboard and select the child user.
    2.  Verify that the live map displays the child's location polyline and the correct status labels.

-   **[✅] Offline Caching and Sync:**
    1.  Stop the backend server to simulate an offline environment.
    2.  Use the child dashboard to send a location update.
    3.  Verify that the location data is cached in `project_sanjaya/logs/cached_points.json`.
    4.  Restart the backend server and send a new location update to trigger the sync.
    5.  Verify that the cached data is synced to the server.

-   **[✅] Admin Trip Management:**
    1.  Log in to the admin dashboard and navigate to the trip management section.
    2.  Pause or end an active trip.
    3.  Verify that the tracking link (`https://<NGROK_URL>/track/<username>-<session_hash>`) stops working.

## Demo Script

The `demo_run.sh` script provides a simple way to simulate a trip. Please note that this script requires `jq` and `bc` to be installed on your system.
