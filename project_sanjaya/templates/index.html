<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jules Tracker - Project Sanjaya</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f5f5f5; margin: 0; padding: 1rem; }
        .container { text-align: center; padding: 2rem; background-color: white; border-radius: 12px; box-shadow: 0 4px_20px rgba(0,0,0,0.1); max-width: 400px; width: 100%; }
        h1 { color: #333; margin-top: 0; }
        p { color: #666; }
        .form-group { margin-bottom: 1rem; text-align: left; }
        label { font-weight: bold; display: block; margin-bottom: 0.5rem; }
        input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background-color: #007aff; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background-color 0.2s; width: 100%; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #status { margin-top: 1.5rem; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ∞Ô∏è Jules Tracker</h1>
        <div id="setup-form">
            <p>Enter your details to begin the tracking session.</p>
            <div class="form-group">
                <label for="name">Your Name:</label>
                <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
                <label for="flightNumber">Flight Number (e.g., 6E245):</label>
                <input type="text" id="flightNumber" name="flightNumber" required>
            </div>
            <div class="form-group">
                <label for="pnr">PNR:</label>
                <input type="text" id="pnr" name="pnr" required>
            </div>
        </div>
        <button id="trackButton">Start Tracking</button>
        <p id="status">Status: Idle</p>
        <p id="coords">Coordinates: N/A</p>
    </div>

    <script>
        const trackButton = document.getElementById('trackButton');
        const statusEl = document.getElementById('status');
        const coordsEl = document.getElementById('coords');
        const setupForm = document.getElementById('setup-form');

        const nameInput = document.getElementById('name');
        const flightNumberInput = document.getElementById('flightNumber');
        const pnrInput = document.getElementById('pnr');

        let isTracking = false;
        let watchId = null;
        let userInfo = {};

        trackButton.addEventListener('click', () => {
            if (!isTracking) {
                if (validateForm()) {
                    userInfo = {
                        name: nameInput.value,
                        flightNumber: flightNumberInput.value,
                        pnr: pnrInput.value
                    };
                    startTracking();
                } else {
                    alert('Please fill in all details.');
                }
            } else {
                stopTracking();
            }
        });

        function validateForm() {
            return nameInput.value.trim() !== '' && flightNumberInput.value.trim() !== '' && pnrInput.value.trim() !== '';
        }

        function startTracking() {
            if (!navigator.geolocation) {
                statusEl.textContent = 'Error: Geolocation is not supported by your browser.';
                return;
            }

            // Disable form and start tracking
            Array.from(setupForm.getElementsByTagName('input')).forEach(i => i.disabled = true);
            isTracking = true;
            trackButton.textContent = 'Stop Tracking';
            statusEl.textContent = 'Status: Initializing...';

            // Send initial user details to the server
            sendSessionDetails();

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    statusEl.textContent = 'Status: Tracking Active';
                    coordsEl.textContent = `Coordinates: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
                    sendLocationToServer(latitude, longitude);
                },
                (error) => {
                    console.error('Geolocation Error:', error);
                    statusEl.textContent = `Error: ${error.message}`;
                    stopTracking();
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        async function stopTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (statusPollInterval) {
                clearInterval(statusPollInterval);
            }

            isTracking = false;
            trackButton.textContent = 'Session Ended';
            trackButton.disabled = true;
            statusEl.textContent = 'Status: Generating summary...';

            try {
                const response = await fetch('/stop_session', { method: 'POST' });
                const summary = await response.json();

                // Display the summary
                const durationHours = (summary.duration_seconds / 3600).toFixed(2);
                statusEl.innerHTML = `
                    <h2>Trip Summary</h2>
                    <p><strong>Total Duration:</strong> ${durationHours} hours</p>
                    <p><strong>Total Ground Distance:</strong> ${summary.total_ground_distance_km} km</p>
                    <p><strong>Data Points Logged:</strong> ${summary.total_points_logged}</p>
                    <p style="margin-top: 1rem; font-size: 0.9em;">You can now close this window.</p>
                `;
                coordsEl.style.display = 'none'; // Hide coordinates display
                setupForm.style.display = 'none'; // Hide form

            } catch (error) {
                console.error("Failed to generate summary:", error);
                statusEl.textContent = 'Status: Error generating summary. Session stopped.';
            }
        }

        async function sendSessionDetails() {
            await fetch('/start_session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userInfo)
            });
        }

        async function sendLocationToServer(lat, lon) {
            await fetch('/log', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lat, lon })
            });
        }

        async function sendStopSignal() {
            await fetch('/stop_session', { method: 'POST' });
        }

        // --- Status Polling ---
        let statusPollInterval = null;

        function startStatusPolling() {
            statusPollInterval = setInterval(async () => {
                try {
                    const response = await fetch('/session_status');
                    const data = await response.json();
                    const currentStatus = data.status;

                    if (!currentStatus) return;

                    // --- Logic to handle state changes ---
                    if (currentStatus === 'in_flight' && isTracking) {
                        statusEl.textContent = `Status: In Flight üõ´. Phone GPS paused.`;
                        // We stop the watch but keep the button as "Stop Tracking"
                        if (watchId !== null) {
                            navigator.geolocation.clearWatch(watchId);
                            watchId = null;
                        }
                    } else if (currentStatus === 'landed' && !isTracking) {
                        // Flight has landed, resume ground tracking
                        statusEl.textContent = 'Status: Landed! Resuming ground tracking...';
                        coordsEl.textContent = 'Coordinates: N/A';
                        // Re-enable form inputs for a new trip is not the goal, so we restart tracking.
                        // We don't need to re-validate the form, just restart the watch.
                        startGeolocationWatch(); // A new function to just start the watch
                    } else if (currentStatus === 'stopped') {
                        statusEl.textContent = 'Status: Tracking Stopped. Refresh to start a new session.';
                        stopTracking();
                        clearInterval(statusPollInterval);
                        trackButton.disabled = true;
                    }

                } catch (error) {
                    console.error("Failed to poll status:", error);
                }
            }, 15000); // Poll every 15 seconds
        }

        function startGeolocationWatch() {
            if (!navigator.geolocation) {
                statusEl.textContent = 'Error: Geolocation is not supported.';
                return;
            }
            if (watchId !== null) return; // Already watching

            isTracking = true; // Mark as tracking
            statusEl.textContent = 'Status: Tracking Active';

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    coordsEl.textContent = `Coordinates: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
                    sendLocationToServer(latitude, longitude);
                },
                (error) => {
                    console.error('Geolocation Error:', error);
                    statusEl.textContent = `Error: ${error.message}`;
                    if (isTracking) stopTracking();
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        // Main function to start the entire process
        function startTracking() {
            // Disable form and update UI
            Array.from(setupForm.getElementsByTagName('input')).forEach(i => i.disabled = true);
            trackButton.textContent = 'Stop Tracking';
            statusEl.textContent = 'Status: Initializing...';

            // Start the session on the backend
            sendSessionDetails();

            // Start polling for server-side status changes
            startStatusPolling();

            // Start the initial ground tracking
            startGeolocationWatch();
        }
    </script>
</body>
</html>